- name: Add host entiries for the Docker containers 
  hosts: custom-desktop-box
  tasks:
      - name: Add docker to hostfile
        lineinfile: dest=/etc/hosts line="192.168.44.60 docker"
      - name: Add rabbitmq to hostfile
        lineinfile: dest=/etc/hosts line="192.168.44.30 rabbitmq"
      - name: Add mongodb to hostfile
        lineinfile: dest=/etc/hosts line="192.168.44.30 mongodb"
      - name: Add mongo to hostfile
        lineinfile: dest=/etc/hosts line="192.168.44.30 mongo"
      - name: Add mysql to hostfile
        lineinfile: dest=/etc/hosts line="192.168.44.30 mysql"
      - name: Add redis to hostfile
        lineinfile: dest=/etc/hosts line="192.168.44.30 redis"
      - name: Add memcached to hostfile
        lineinfile: dest=/etc/hosts line="192.168.44.30 memcached"
      - name: Add elasticsearch to hostfile
        lineinfile: dest=/etc/hosts line="192.168.44.30 elasticsearch"
      - name: Add nginx to hostfile
        lineinfile: dest=/etc/hosts line="192.168.44.30 nginx"
      - name: Add postgresql to hostfile
        lineinfile: dest=/etc/hosts line="192.168.44.30 postgresql"
      - name: Add logfaces to hostfile 
        lineinfile: dest=/etc/hosts line="192.168.254.123 logfaces"
      - name: Add logfaces-boston to hostfile 
        lineinfile: dest=/etc/hosts line="192.168.100.124 logfaces-boston"
      - name: Add mongo1test to hostfile
        lineinfile: dest=/etc/hosts line="192.168.254.57 mongo1test"
      - name: Add mongo2test to hostfile
        lineinfile: dest=/etc/hosts line="192.168.254.58 mongo2test"
      - name: Add mongo3test to hostfile
        lineinfile: dest=/etc/hosts line="192.168.254.59 mongo3test"
      - name: Add stagetwo to hostfile
        lineinfile: dest=/etc/hosts line="192.168.255.29 stagetwo"
      - name: Add cd0 to hostfile 
        lineinfile: dest=/etc/hosts line="192.168.254.85 cd0"
      - name: Add cd1 to hostfile 
        lineinfile: dest=/etc/hosts line="192.168.254.81 cd1"
      - name: Add cd5 to hostfile 
        lineinfile: dest=/etc/hosts line="192.168.254.114 cd5"
      - name: Add cd6 to hostfile 
        lineinfile: dest=/etc/hosts line="192.168.254.59 cd6"
      - name: Add rabbit-test to hostfile 
        lineinfile: dest=/etc/hosts line="192.168.254.28 rabbit-test"
      - name: Add docker1test to hostfile
        lineinfile: dest=/etc/hosts line="192.168.254.58 docker1test"

- name: Make per-project tweaks to RabbitMQ 
  hosts: custom-desktop-box
  tasks:
    - name: Copy hostname script to a safe place
      copy: src=scripts/add-virtualhost.sh dest=/tmp/add-virtualhost.sh owner=root group=root mode=755 backup=no
    - name: Add Sush-E virtual host 
      command: /tmp/add-virtualhost.sh sush-e rabbitmq guest guest
    - name: Add Mold-E virtual host 
      command: /tmp/add-virtualhost.sh mold-e rabbitmq guest guest
    - name: Add Asgard virtual host 
      command: /tmp/add-virtualhost.sh asgard rabbitmq guest guest
    - name: Add Khujand virtual host 
      command: /tmp/add-virtualhost.sh khujand rabbitmq guest guest

- name: Create custom databases 
  hosts: nobody
  tasks:
    - name: Installing required dependencies so we can use Ansible MySQL modules
      apt: name={{ item }} state=present
      with_items:
        - mysql-client
        - python-mysqldb
    - name: Sush-E Database 
      mysql_db: name=sushe state=present encoding=utf8 collation=utf8_general_ci login_host=mysql login_user=root login_password=mysql

- name: Custom Desktop tweeks 
  hosts: custom-desktop-box
  tasks:
      - name: Install custom desktop packages
        apt: "name={{ item }} state=present"
        with_items:
           - cvs 
      - name: Create Asgard project directory
        file: path=/home/vagrant/Stash/Asgard state=directory
      - name: Create Gradle project directory
        file: path=/home/vagrant/Stash/Gradle state=directory
      - name: Create Khujand project directory
        file: path=/home/vagrant/Stash/Khujand state=directory
      - name: Create Mold-E project directory
        file: path=/home/vagrant/Stash/Mold-E state=directory
      - name: Create Sush-E project directory
        file: path=/home/vagrant/Stash/Sush-E state=directory
      - name: Set permissions on the home directory
        file: path=/home/vagrant owner=vagrant group=vagrant recurse=true state=directory
      - name: Copy alias change script to a safe place
        copy: src=scripts/add-alias.sh dest=/tmp/add-alias.sh owner=root group=root mode=755 backup=no
      - name: add an alias to quickly change to the Asgard directory
        command: /tmp/add-alias.sh asgard 'cd /home/vagrant/Stash/Asgard'
      - name: add an alias to quickly change to the Mold-E directory
        command: /tmp/add-alias.sh molde 'cd /home/vagrant/Stash/Mold-E'
      - name: add an alias to quickly change to the Sush-E directory
        command: /tmp/add-alias.sh sushe 'cd /home/vagrant/Stash/Sush-E'
      - name: Install HTTP IE (cURL replacement)
        pip: name=setuptools
      - pip: name=httpie

- name: Docker Registry (must be on VPN)
  hosts: all
  sudo: True
  tasks:
      - name: Create CA certificates directory
        file: path=/usr/local/share/ca-certificates/docker-registry state=directory
      - name: Create SSL certificates directory
        file: path=/etc/ssl/certs/ state=directory
      - name: Create SSL certificates directory
        get_url: >
                url=http://192.168.254.81:81/artifactory/static/ease/docker-registry/certifcate/registry.transparent.CA.crt
                dest=/usr/local/share/ca-certificates/docker-registry/registry.transparent.CA.crt
        register: certificate
      - name: Add registry to hosts file
        lineinfile: dest=/etc/hosts line="192.168.254.90 registry.transparent.com"
      - name: Add cd1 to hosts file
        lineinfile: dest=/etc/hosts line="192.168.254.81 cd1"
      - name: Update certificates
        shell: update-ca-certificates
        when: certificate|changed
      - name: Grab configuration file
        get_url: url=http://192.168.254.81:81/artifactory/static/ease/docker-registry/.dockercfg dest=/root/.dockercfg
      - name: Restart Docker
        command: service docker restart
        when: certificate|changed
